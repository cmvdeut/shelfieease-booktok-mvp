name: Publish Scheduled Social Media Posts

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:         # Allow manual trigger from GitHub UI

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Publish due posts
        env:
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_USER_ID: ${{ secrets.INSTAGRAM_USER_ID }}
          TIKTOK_ACCESS_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
          TIKTOK_REFRESH_TOKEN: ${{ secrets.TIKTOK_REFRESH_TOKEN }}
          TIKTOK_CLIENT_KEY: ${{ secrets.TIKTOK_CLIENT_KEY }}
          TIKTOK_CLIENT_SECRET: ${{ secrets.TIKTOK_CLIENT_SECRET }}
          TIKTOK_USE_DIRECT_POST: ${{ secrets.TIKTOK_USE_DIRECT_POST }}
          TIKTOK_PRIVACY_LEVEL: ${{ secrets.TIKTOK_PRIVACY_LEVEL }}
        run: |
          QUEUE_FILE="scheduled-posts.json"
          LOG_FILE="social-posts-log.md"
          NOW=$(date -u +%s)

          # Check if queue exists and has items
          if [ ! -f "$QUEUE_FILE" ] || [ "$(cat $QUEUE_FILE)" = "[]" ]; then
            echo "No scheduled posts in queue."
            exit 0
          fi

          # Read queue
          QUEUE=$(cat "$QUEUE_FILE")

          # Process each post
          echo "$QUEUE" | jq -c '.[]' | while IFS= read -r POST; do
            SCHEDULED=$(echo "$POST" | jq -r '.scheduled_time_unix')
            PLATFORM=$(echo "$POST" | jq -r '.platform')
            CAPTION_PREVIEW=$(echo "$POST" | jq -r '.caption_preview')
            SCHEDULED_LABEL=$(echo "$POST" | jq -r '.scheduled_label')

            if [ "$NOW" -ge "$SCHEDULED" ]; then
              echo "Publishing: $CAPTION_PREVIEW"

              if [ "$PLATFORM" = "instagram" ]; then
                CONTAINER_ID=$(echo "$POST" | jq -r '.container_id')
                VIDEO_USED=$(echo "$POST" | jq -r '.video_used')

                RESPONSE=$(curl -s -X POST \
                  "https://graph.facebook.com/v21.0/${INSTAGRAM_USER_ID}/media_publish" \
                  --data-urlencode "creation_id=${CONTAINER_ID}" \
                  --data-urlencode "access_token=${INSTAGRAM_ACCESS_TOKEN}")

                POST_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

                if [ -n "$POST_ID" ]; then
                  sleep 5
                  PERMALINK=$(curl -s \
                    "https://graph.facebook.com/v21.0/${INSTAGRAM_USER_ID}/media?fields=id,permalink&limit=1&access_token=${INSTAGRAM_ACCESS_TOKEN}" \
                    | jq -r '.data[0].permalink // "URL ophalen mislukt"')

                  echo "Published! URL: $PERMALINK"

                  TIMESTAMP=$(date -u "+%Y-%m-%d %H:%M UTC")
                  printf '\n## %s — Scheduled post (auto-published)\n\n' "$TIMESTAMP" >> "$LOG_FILE"
                  printf '| Field | Value |\n' >> "$LOG_FILE"
                  printf '|-------|-------|\n' >> "$LOG_FILE"
                  printf '| Datum | %s |\n' "$TIMESTAMP" >> "$LOG_FILE"
                  printf '| Platform | Instagram |\n' >> "$LOG_FILE"
                  printf '| Gepland voor | %s |\n' "$SCHEDULED_LABEL" >> "$LOG_FILE"
                  printf '| Video gebruikt | %s |\n' "$VIDEO_USED" >> "$LOG_FILE"
                  printf '| Live URL | %s |\n' "$PERMALINK" >> "$LOG_FILE"
                  printf '| Caption preview | %s |\n' "$CAPTION_PREVIEW" >> "$LOG_FILE"
                  printf '| Status | Gepubliceerd via GitHub Actions |\n\n' >> "$LOG_FILE"
                  printf '---\n' >> "$LOG_FILE"
                else
                  echo "ERROR publishing $CONTAINER_ID: $RESPONSE"
                  echo "$POST" >> /tmp/keep_posts.json
                fi

              elif [ "$PLATFORM" = "tiktok" ]; then
                VIDEO_FILE=$(echo "$POST" | jq -r '.video_file')
                CAPTION=$(echo "$POST" | jq -r '.caption // .caption_preview // ""')

                # Refresh token first
                REFRESH_RESPONSE=$(curl -s -X POST "https://open.tiktokapis.com/v2/oauth/token/" \
                  -H "Content-Type: application/x-www-form-urlencoded" \
                  -d "client_key=${TIKTOK_CLIENT_KEY}" \
                  -d "client_secret=${TIKTOK_CLIENT_SECRET}" \
                  -d "grant_type=refresh_token" \
                  -d "refresh_token=${TIKTOK_REFRESH_TOKEN}")
                NEW_TOKEN=$(echo "$REFRESH_RESPONSE" | jq -r '.access_token // empty')
                if [ -z "$NEW_TOKEN" ]; then
                  NEW_TOKEN="$TIKTOK_ACCESS_TOKEN"
                fi

                FILE_SIZE=$(stat -c%s "$VIDEO_FILE")
                PRIVACY_LEVEL="${TIKTOK_PRIVACY_LEVEL:-SELF_ONLY}"

                if [ "$TIKTOK_USE_DIRECT_POST" = "true" ]; then
                  # Direct Post: video + caption in one go (needs video.publish scope)
                  INIT_BODY=$(jq -n \
                    --arg title "$CAPTION" \
                    --arg pl "$PRIVACY_LEVEL" \
                    --argjson vs "$FILE_SIZE" \
                    '{ post_info: { title: $title, privacy_level: $pl }, source_info: { source: "FILE_UPLOAD", video_size: $vs, chunk_size: $vs, total_chunk_count: 1 } }')
                  INIT_URL="https://open.tiktokapis.com/v2/post/publish/video/init/"
                  STATUS_LABEL="Direct post (caption mee)"
                else
                  # Inbox: video only, caption handmatig in app
                  INIT_BODY=$(jq -n --argjson vs "$FILE_SIZE" '{ source_info: { source: "FILE_UPLOAD", video_size: $vs, chunk_size: $vs, total_chunk_count: 1 } }')
                  INIT_URL="https://open.tiktokapis.com/v2/post/publish/inbox/video/init/"
                  STATUS_LABEL="In TikTok inbox — open app en tik Publish"
                fi

                INIT_RESPONSE=$(curl -s -X POST "$INIT_URL" \
                  -H "Authorization: Bearer ${NEW_TOKEN}" \
                  -H "Content-Type: application/json; charset=UTF-8" \
                  -d "$INIT_BODY")

                PUBLISH_ID=$(echo "$INIT_RESPONSE" | jq -r '.data.publish_id // empty')
                UPLOAD_URL=$(echo "$INIT_RESPONSE" | jq -r '.data.upload_url // empty')

                if [ -n "$UPLOAD_URL" ]; then
                  LAST_BYTE=$((FILE_SIZE - 1))

                  # Upload video
                  curl -s -X PUT "$UPLOAD_URL" \
                    -H "Content-Type: video/mp4" \
                    -H "Content-Range: bytes 0-${LAST_BYTE}/${FILE_SIZE}" \
                    -H "Content-Length: ${FILE_SIZE}" \
                    --data-binary "@${VIDEO_FILE}"

                  echo "TikTok upload done! Publish ID: $PUBLISH_ID"

                  # Save pending post for caption helper page
                  UPLOADED_AT=$(date -u +%s)
                  echo "$POST" | jq --argjson ua "$UPLOADED_AT" '. + {uploaded_at: $ua}' > /tmp/tiktok-pending.json

                  TIMESTAMP=$(date -u "+%Y-%m-%d %H:%M UTC")
                  printf '\n## %s — Scheduled TikTok post (auto-uploaded)\n\n' "$TIMESTAMP" >> "$LOG_FILE"
                  printf '| Field | Value |\n' >> "$LOG_FILE"
                  printf '|-------|-------|\n' >> "$LOG_FILE"
                  printf '| Datum | %s |\n' "$TIMESTAMP" >> "$LOG_FILE"
                  printf '| Platform | TikTok |\n' >> "$LOG_FILE"
                  printf '| Gepland voor | %s |\n' "$SCHEDULED_LABEL" >> "$LOG_FILE"
                  printf '| Video gebruikt | %s |\n' "$VIDEO_FILE" >> "$LOG_FILE"
                  printf '| Caption preview | %s |\n' "$CAPTION_PREVIEW" >> "$LOG_FILE"
                  printf '| Status | %s |\n\n' "$STATUS_LABEL" >> "$LOG_FILE"
                  printf '---\n' >> "$LOG_FILE"
                else
                  echo "ERROR init TikTok upload: $INIT_RESPONSE"
                  echo "$POST" >> /tmp/keep_posts.json
                fi
              fi

            else
              # Not due yet, keep in queue
              echo "$POST" >> /tmp/keep_posts.json
            fi
          done

          # Rebuild queue from kept posts
          if [ -f /tmp/keep_posts.json ]; then
            NEW_QUEUE=$(cat /tmp/keep_posts.json | jq -s '.')
          else
            NEW_QUEUE="[]"
          fi

          echo "$NEW_QUEUE" > "$QUEUE_FILE"

          # Write tiktok-data.json for caption helper page (shelfieease.app/tiktok)
          PENDING_DATA=$(cat /tmp/tiktok-pending.json 2>/dev/null || echo "null")
          UPCOMING_DATA=$(echo "$NEW_QUEUE" | jq '[.[] | select(.platform == "tiktok")] | .[0:5]')
          UPDATED_AT=$(date -u +%s)
          jq -n \
            --argjson pending "$PENDING_DATA" \
            --argjson upcoming "$UPCOMING_DATA" \
            --argjson updated "$UPDATED_AT" \
            '{pending: $pending, upcoming: $upcoming, updated_at: $updated}' \
            > public/tiktok-data.json

      - name: Commit updated queue and log
        run: |
          git config user.name "ShelfieEase Bot"
          git config user.email "bot@shelfieease.app"
          git add -A
          if git diff --staged --quiet; then
            echo "Nothing to commit - queue was empty."
          else
            git commit -m "Auto-publish scheduled posts [skip ci]"
            git push
          fi
